name: Ipk
'on':
  push:
    branches:
      - master
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: setup node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'
      - name: setup dotnet8
        uses: actions/setup-dotnet@v2
        env:
          GITHUB_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
        with:
          dotnet-version: 8.0.x
      
      - name: setup ipk
        run: sudo apt-get install binutils tar gzip

      - name: chmod shell
        run: sed -i 's/\r$//' publish-ipk.sh
      - name: chmod shell
        run: chmod +x publish-ipk.sh
      - name: publish projects
        run: ./publish-ipk.sh
    
      - name: Get Release Info
        id: get_release
        env:
          GITHUB_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
        run: |
          # 获取已存在的 Release 信息
          RELEASE_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ github.ref_name }}")
          
          # 提取 upload_url
          UPLOAD_URL=$(echo "$RELEASE_INFO" | jq -r '.upload_url' | sed 's/{?name,label}//')
          
          # 设置输出变量
          echo "upload_url=$UPLOAD_URL" >> $GITHUB_OUTPUT
    